<div class="page-container">

    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-text">
            <h1><i class="bi bi-person-badge-fill text-primary-custom"></i> Patient Management</h1>
            <p>Register patients, process blood requests and track status</p>
        </div>
        <div class="page-header-actions">
            <button class="btn-primary-custom" (click)="openAddForm()">
                <i class="bi bi-plus-lg"></i> Add Patient
            </button>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <div class="search-input">
            <i class="bi bi-search"></i>
            <input class="form-input-custom" type="text" placeholder="Search patients by name..."
                [(ngModel)]="searchName" (keyup.enter)="applyFilters()">
        </div>
        <select class="form-input-custom" [(ngModel)]="filterBloodGroup" style="min-width:150px;max-width:180px">
            <option value="">All Blood Groups</option>
            @for (bg of bloodGroups; track bg) {
            <option [value]="bg">{{ bg }}</option>
            }
        </select>
        <button class="btn-primary-custom" (click)="applyFilters()"><i class="bi bi-funnel-fill"></i> Filter</button>
        <button class="btn-secondary-custom" (click)="resetFilters()"><i class="bi bi-arrow-counterclockwise"></i>
            Reset</button>
    </div>

    @if (loading) {
    <app-skeleton-loader type="table" [count]="6"></app-skeleton-loader>
    } @else {

    <p style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:12px">
        Showing <strong>{{ patients.length }}</strong> patient{{ patients.length !== 1 ? 's' : '' }}
    </p>

    <div class="card-custom">
        <div class="card-custom-body" style="padding:0">
            @if (patients.length > 0) {
            <div style="overflow-x:auto">
                <table class="table-custom">
                    <thead>
                        <tr>
                            <th>Patient</th>
                            <th>ID</th>
                            <th>Gender</th>
                            <th>Blood Group</th>
                            <th>Component</th>
                            <th>Contact</th>
                            <th>Source</th>
                            <th>Status</th>
                            <th style="text-align:right">Actions</th>
                        </tr>
                    </thead>
                    <tbody @staggerList>
                        @for (patient of patients; track patient._id) {
                        <tr>
                            <td>
                                <div style="display:flex;align-items:center;gap:10px">
                                    <span class="user-initial" [style.background]="getInitialColor(patient.name)">{{
                                        patient.name.charAt(0) }}</span>
                                    <div>
                                        <span style="font-weight:500">{{ patient.name }}</span>
                                        @if (patient.urgencyLevel && patient.urgencyLevel !== 'Normal') {
                                        <span class="badge-custom" [ngClass]="getUrgencyClass(patient.urgencyLevel)"
                                            style="font-size:0.65rem;padding:2px 6px;margin-left:6px">
                                            {{ patient.urgencyLevel }}
                                        </span>
                                        }
                                    </div>
                                </div>
                            </td>
                            <td><span class="font-mono" style="color:var(--text-muted)">{{ patient.patientId }}</span>
                            </td>
                            <td>{{ patient.gender }}</td>
                            <td><span class="badge-custom badge-blood">{{ patient.bloodGroup }}</span></td>
                            <td>
                                <span style="font-size:0.8rem;color:var(--text-secondary)">{{ patient.component ||
                                    'Whole Blood' }}</span>
                            </td>
                            <td>{{ patient.contact }}</td>
                            <td>
                                <span class="badge-custom" [ngClass]="getSourceClass(patient.source)"
                                    style="font-size:0.72rem">
                                    <i class="bi"
                                        [ngClass]="patient.source === 'Public' ? 'bi-globe' : 'bi-person-badge'"></i>
                                    {{ patient.source || 'Staff' }}
                                </span>
                            </td>
                            <td>
                                <span class="badge-custom" [ngClass]="getStatusClass(patient.requestStatus)">
                                    <i class="bi" [ngClass]="getStatusIcon(patient.requestStatus)"></i>
                                    {{ patient.requestStatus || 'Pending' }}
                                </span>
                            </td>
                            <td style="text-align:right">
                                <div style="display:flex;gap:6px;justify-content:flex-end">
                                    @if (patient.requestStatus === 'Pending') {
                                    <button class="btn-primary-custom" style="font-size:0.78rem;padding:6px 10px"
                                        (click)="requestBlood(patient)">
                                        <i class="bi bi-droplet-fill"></i> Request
                                    </button>
                                    }
                                    <button class="btn-icon danger" title="Delete" (click)="deletePatient(patient)">
                                        <i class="bi bi-trash3-fill"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
            } @else {
            <app-empty-state icon="bi-person-badge" title="No patients found"
                message="No patients match your current filters. Try adjusting your search or add a new patient.">
                <button class="btn-primary-custom" (click)="openAddForm()"><i class="bi bi-plus-lg"></i> Add
                    Patient</button>
            </app-empty-state>
            }
        </div>
    </div>
    }

    <!-- Add Patient Modal -->
    @if (showAddForm) {
    <div class="modal-overlay" (click)="closeForm()">
        <div class="modal-container" (click)="$event.stopPropagation()">
            <div class="modal-header-custom">
                <h3><i class="bi bi-person-plus-fill" style="margin-right:8px;color:var(--primary)"></i> Register New
                    Patient</h3>
                <button class="modal-close-btn" (click)="closeForm()"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="modal-body-custom">
                <form #patientFormRef="ngForm">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label class="form-label-custom">Full Name <span class="required">*</span></label>
                            <input class="form-input-custom" type="text" [(ngModel)]="patientForm.name" name="name"
                                required placeholder="e.g. Jane Smith" #pNameField="ngModel">
                            @if (pNameField.invalid && pNameField.touched) {
                            <span class="validation-msg"><i class="bi bi-exclamation-circle"></i> Name is
                                required</span>
                            }
                        </div>
                        <div class="form-group">
                            <label class="form-label-custom">Gender <span class="required">*</span></label>
                            <select class="form-input-custom" [(ngModel)]="patientForm.gender" name="gender" required>
                                @for (g of genders; track g) { <option [value]="g">{{ g }}</option> }
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label-custom">Blood Group <span class="required">*</span></label>
                            <select class="form-input-custom" [(ngModel)]="patientForm.bloodGroup" name="bloodGroup"
                                required>
                                @for (bg of bloodGroups; track bg) { <option [value]="bg">{{ bg }}</option> }
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label-custom">Component Needed</label>
                            <select class="form-input-custom" [(ngModel)]="patientForm.component" name="component">
                                @for (comp of components; track comp) {
                                <option [value]="comp">{{ comp }}</option>
                                }
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label-custom">Contact Number <span class="required">*</span></label>
                            <input class="form-input-custom" type="text" [(ngModel)]="patientForm.contact"
                                name="contact" pattern="[0-9]{10}" required placeholder="e.g. 9876543210"
                                #pContactField="ngModel">
                            @if (pContactField.invalid && pContactField.touched) {
                            <span class="validation-msg"><i class="bi bi-exclamation-circle"></i> Enter a valid 10-digit
                                number</span>
                            }
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer-custom">
                <button class="btn-secondary-custom" (click)="closeForm()">Cancel</button>
                <button class="btn-primary-custom" (click)="savePatient()" [disabled]="!patientFormRef.valid">
                    <i class="bi bi-plus-lg"></i> Register Patient
                </button>
            </div>
        </div>
    </div>
    }

    <!-- Confirm Modal -->
    <app-confirm-modal [show]="showConfirm" [title]="confirmTitle" [message]="confirmMessage" [variant]="confirmVariant"
        [confirmText]="confirmVariant === 'danger' ? 'Delete' : 'Confirm'" (confirmed)="onConfirm()"
        (cancelled)="onCancelConfirm()">
    </app-confirm-modal>

</div>